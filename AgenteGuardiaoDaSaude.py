# -*- coding: utf-8 -*-
"""AgenteMedicamentos2.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1J9nVDvR7sJDbZIuEHyzQ4em64kTamRbi
"""

# Commented out IPython magic to ensure Python compatibility.
# -*- coding: utf-8 -*-
"""AgenteMedicamentos.ipynb"""

# Instalar as bibliotecas necess√°rias
# %pip -q install google-genai
# %pip -q install google-genai google-adk google-auth-oauthlib google-api-python-client

# Configurar a API Key do Google Gemini
import os
from google.colab import userdata

os.environ["GOOGLE_API_KEY"] = userdata.get('GOOGLE_API_KEY')

# Configurar o cliente da SDK do Gemini
from google import genai

client = genai.Client()

# Verificar modelos dispon√≠veis
for model in client.models.list():
    print(model.name)

MODEL_ID = "gemini-2.0-flash"

# Commented out IPython magic to ensure Python compatibility.
# %pip -q install google-adk

# Importa√ß√µes necess√°rias
from IPython.display import HTML, Markdown
from google.adk.agents import Agent
from google.adk.runners import Runner
from google.adk.sessions import InMemorySessionService
from google.adk.tools import google_search
from google.genai import types  # Para criar conte√∫dos (Content e Part)
from datetime import date
import textwrap  # Para formatar melhor a sa√≠da de texto
import re  # Para express√µes regulares
import warnings

warnings.filterwarnings("ignore")

# Fun√ß√£o auxiliar que envia uma mensagem para um agente via Runner e retorna a resposta final
def call_agent(agent: Agent, message_text: str) -> str:
    # Cria um servi√ßo de sess√£o em mem√≥ria
    session_service = InMemorySessionService()
    # Cria uma nova sess√£o (voc√™ pode personalizar os IDs conforme necess√°rio)
    session = session_service.create_session(app_name=agent.name, user_id="user1", session_id="session1")
    # Cria um Runner para o agente
    runner = Runner(agent=agent, app_name=agent.name, session_service=session_service)
    # Cria o conte√∫do da mensagem de entrada
    content = types.Content(role="user", parts=[types.Part(text=message_text)])

    final_response = ""
    # Itera assincronamente pelos eventos retornados durante a execu√ß√£o do agente
    for event in runner.run(user_id="user1", session_id="session1", new_message=content):
        if event.is_final_response():
          for part in event.content.parts:
            if part.text is not None:
              final_response += part.text
              final_response += "\n"
    return final_response

# Fun√ß√£o auxiliar para exibir texto formatado em Markdown no Colab
def to_markdown(text):
  text = text.replace('‚Ä¢', '  *')
  return Markdown(textwrap.indent(text, '> ', predicate=lambda _: True))

# Fun√ß√£o Auxiliar de Agenda Google
from dateutil import parser
from googleapiclient.discovery import build
from google.oauth2 import service_account

def setup_google_calendar():
    SCOPES = ['https://www.googleapis.com/auth/calendar']
    SERVICE_ACCOUNT_FILE = 'credentials.json'
    creds = service_account.Credentials.from_service_account_file(SERVICE_ACCOUNT_FILE, scopes=SCOPES)
    service = build('calendar', 'v3', credentials=creds)
    return service

from googleapiclient.discovery import build
from google.oauth2 import service_account

def setup_google_calendar():
    SCOPES = ['https://www.googleapis.com/auth/calendar']
    SERVICE_ACCOUNT_FILE = 'credentials.json'
    creds = service_account.Credentials.from_service_account_file(SERVICE_ACCOUNT_FILE, scopes=SCOPES)
    service = build('calendar', 'v3', credentials=creds)
    return service

# Fun√ß√£o para configurar acesso ao Google Calendar
def setup_google_calendar():
    """Configura a autentica√ß√£o do Google Calendar e retorna o servi√ßo."""
    SCOPES = ['https://www.googleapis.com/auth/calendar']
    creds = None

    # Tenta obter credenciais do arquivo token.pickle
    if os.path.exists('token.pickle'):
        with open('token.pickle', 'rb') as token:
            creds = pickle.load(token)

    # Se n√£o h√° credenciais v√°lidas, solicita autentica√ß√£o
    if not creds or not creds.valid:
        if creds and creds.expired and creds.refresh_token:
            creds.refresh(Request())
        else:
            flow = InstalledAppFlow.from_client_secrets_file(
                'credentials.json', SCOPES)
            creds = flow.run_local_server(port=0)

        # Salva as credenciais para a pr√≥xima execu√ß√£o
        with open('token.pickle', 'wb') as token:
            pickle.dump(creds, token)

    # Retorna o servi√ßo do Google Calendar
    return build('calendar', 'v3', credentials=creds)

# Fun√ß√£o para criar eventos no Google Calendar
def criar_evento_calendar(service, titulo, descricao, data_inicio, hora_inicio, duracao_minutos=15, recorrencia=None):
    """
    Cria um evento no Google Calendar.

    Args:
        service: Servi√ßo do Google Calendar
        titulo: T√≠tulo do evento
        descricao: Descri√ß√£o do evento
        data_inicio: Data de in√≠cio no formato DD/MM/AAAA
        hora_inicio: Hora de in√≠cio no formato HH:MM
        duracao_minutos: Dura√ß√£o do evento em minutos
        recorrencia: Lista com regra de recorr√™ncia RRULE (opcional)

    Returns:
        Link do evento criado ou mensagem de erro
    """
    try:
        # Converter data e hora para o formato ISO
        data_hora_inicio = datetime.strptime(f"{data_inicio} {hora_inicio}", "%d/%m/%Y %H:%M")
        data_hora_fim = data_hora_inicio + timedelta(minutes=duracao_minutos)

        # Preparar o corpo do evento
        event_body = {
            'summary': titulo,
            'description': descricao,
            'start': {
                'dateTime': data_hora_inicio.isoformat(),
                'timeZone': 'America/Sao_Paulo',  # Ajuste para seu fuso hor√°rio
            },
            'end': {
                'dateTime': data_hora_fim.isoformat(),
                'timeZone': 'America/Sao_Paulo',  # Ajuste para seu fuso hor√°rio
            },
            'reminders': {
                'useDefault': False,
                'overrides': [
                    {'method': 'popup', 'minutes': 10},
                ],
            },
        }

        # Adicionar recorr√™ncia se especificada
        if recorrencia:
            event_body['recurrence'] = recorrencia

        # Criar o evento
        event = service.events().insert(calendarId='primary', body=event_body).execute()

        return f"Evento criado com sucesso: {event.get('htmlLink')}"

    except Exception as e:
        return f"Erro ao criar evento: {str(e)}"

# Fun√ß√£o para criar eventos de medica√ß√£o no Google Calendar
def agendar_medicacao_calendar(service, nome_remedio, frequencia, data_inicio, hora_inicio, duracao_dias):
    """
    Agenda a medica√ß√£o no Google Calendar com base na frequ√™ncia.

    Args:
        service: Servi√ßo do Google Calendar
        nome_remedio: Nome do medicamento
        frequencia: Frequ√™ncia em horas (ex: 8 para cada 8 horas)
        data_inicio: Data de in√≠cio no formato DD/MM/AAAA
        hora_inicio: Hora de in√≠cio no formato HH:MM
        duracao_dias: Dura√ß√£o do tratamento em dias

    Returns:
        Lista de links para os eventos criados
    """
    # Calcular quantas vezes por dia o medicamento deve ser tomado
    vezes_por_dia = 24 // frequencia

    # Calcular data de t√©rmino
    data_inicio_dt = datetime.strptime(data_inicio, "%d/%m/%Y")
    data_fim = data_inicio_dt + timedelta(days=duracao_dias)
    data_fim_str = data_fim.strftime("%Y%m%d")

    resultados = []

    # Criar um evento para cada hor√°rio do dia
    hora_atual = datetime.strptime(hora_inicio, "%H:%M")

    for i in range(vezes_por_dia):
        hora_evento = hora_atual.strftime("%H:%M")
        titulo = f"Tomar {nome_remedio}"
        descricao = f"Hor√°rio programado para tomar {nome_remedio}."

        # Configurar recorr√™ncia di√°ria at√© a data de t√©rmino
        recorrencia = [f'RRULE:FREQ=DAILY;UNTIL={data_fim_str}']

        # Criar o evento
        resultado = criar_evento_calendar(
            service,
            titulo,
            descricao,
            data_inicio,
            hora_evento,
            duracao_minutos=15,
            recorrencia=recorrencia
        )

        resultados.append(resultado)

        # Avan√ßar para o pr√≥ximo hor√°rio
        hora_atual = hora_atual + timedelta(hours=frequencia)

    # Adicionar evento para comprar mais medicamento (2 dias antes do t√©rmino)
    data_compra = data_fim - timedelta(days=2)
    data_compra_str = data_compra.strftime("%d/%m/%Y")
    titulo_compra = f"Comprar {nome_remedio}"
    descricao_compra = f"Lembrete para comprar mais {nome_remedio} antes que o estoque acabe."

    resultado_compra = criar_evento_calendar(
        service,
        titulo_compra,
        descricao_compra,
        data_compra_str,
        "09:00",  # Hor√°rio padr√£o para lembrete de compra
        duracao_minutos=30,
        recorrencia=None  # Evento √∫nico
    )

    resultados.append(resultado_compra)

    return resultados# -*- coding: utf-8 -*-

##########################################
# --- Agente 1: Agente avaliador do receituario --- #
##########################################
def agente_avaliador(receituario, idade, data):
    avaliador = Agent(
        name="agente_avaliador",
        model=MODEL_ID,
        instruction="""
        Voc√™ √© um m√©dico e tamb√©m foi graduado em farm√°cia. A sua tarefa √© usar a ferramenta de busca do google (google_search) para obter informa√ß√µes atuais de medicamentos, sempre procurar em locais confi√°veis, tal como o laborat√≥rio, anvisa ou entes confi√°veis.
        Ao obter a informa√ß√£o do receitu√°rio e informar em t√≥picos de forma clara e objetiva:
          Se o que consta no receitu√°rio √© a subst√¢ncia ativa ou se √© um medicamento, identificar e escrever seu nome identificado no receitu√°rio.
          (Exemplo: Tomar Ibuprofeno 500mg a cada 8 horas por 7 dias. Via oral. Identificado que ibuprofeno √© a subst√¢ncia ativa e n√£o o nome do medicamento, logo Subst√¢ncia Ativa: Ibuprofeno)
          Sua a√ß√£o terap√™utica;
          Dosagem conforme idade do usu√°rio, sua dosagem m√°xima e se dosagem orientada est√° dentro do recomendado pelo medicamento;
          Frequ√™ncia de administra√ß√£o e se a frequ√™ncia orientada est√° dentro do recomendado pelo medicamento;
          Intera√ß√µes medicamentosas,
          Efeitos secund√°rios;
          Contra indica√ß√µes;
          Informar qual o medicamento mais vendido ou mais famoso desta subst√¢ncia ou medicamento.

        Indicar Nota de rodap√© com siglas ou jarg√µes de termos t√©cnicos, pe√ßo que os explique de forma simples e concisa.

        Importante: No in√≠cio da sua resposta, inclua CLARAMENTE uma linha iniciando com:
        "SUBST√ÇNCIA ATIVA: [nome]" ou "MEDICAMENTO: [nome]" conforme sua an√°lise.
        """,
        description="Agente que busca informa√ß√µes do medicamento no Google",
        tools=[google_search]
    )

    entrada_do_agente_avaliador = f"receitu√°rio: {receituario}\nIdade: {idade}\nData atual: {data}"

    avaliacao_receituario = call_agent(avaliador, entrada_do_agente_avaliador)

    # Extrair informa√ß√µes de medicamento e subst√¢ncia ativa da resposta
    medicamento = None
    substancia_ativa = None

    # Procurar por "MEDICAMENTO:" na resposta
    med_match = re.search(r"MEDICAMENTO:\s*([^\n]+)", avaliacao_receituario)
    if med_match:
        medicamento = med_match.group(1).strip()

    # Procurar por "SUBST√ÇNCIA ATIVA:" na resposta
    sub_match = re.search(r"SUBST√ÇNCIA ATIVA:\s*([^\n]+)", avaliacao_receituario)
    if sub_match:
        substancia_ativa = sub_match.group(1).strip()

    return avaliacao_receituario, medicamento, substancia_ativa

################################################
# --- Agente 2: Planejador gen√©rico --- #
################################################
def agente_generico(identificado, cidade, estado):
    generico = Agent(
        name="agente_generico",
        model=MODEL_ID,
        instruction=f"""
        Voc√™ √© um assistente de busca por medicamentos gen√©ricos.

        Sua tarefa √© usar as informa√ß√µes fornecidas para buscar no google (Google Search)
        por medicamentos gen√©ricos que correspondam ao medicamento ou subst√¢ncia ativa
        detalhada na 'Informa√ß√£o do Medicamento'.

        Ap√≥s identificar os gen√©ricos, busque pelo **pre√ßo m√©dio** desses medicamentos gen√©ricos
        especificamente para a localiza√ß√£o da **cidade** do **estado** informado.

        Apresente os resultados listando os nomes dos medicamentos gen√©ricos encontrados
        e seus respectivos pre√ßos m√©dios na cidade especificada, informe atrav√©s de uma tabela.

        --- Informa√ß√£o do Medicamento ---
        {identificado}

        --- Cidade do Usu√°rio ---
        {cidade}
        --- Cidade do Usu√°rio ---
        {estado}
        """,
        description="Agente que busca os medicamentos gen√©ricos e seu pre√ßo m√©dio",
        tools=[google_search]
    )

    # Executa o agente
    medicamento_generico = call_agent(generico, f"Buscar gen√©ricos para {identificado}")
    return medicamento_generico

######################################
# --- Agente 3: Agente Farmacia --- #
######################################
def agente_farmacia(bairro, cidade, estado):
    farmacia = Agent(
        name="agente_farmacia",
        model=MODEL_ID,
        instruction="""
            Voc√™ √© um agente de assist√™ncia que ajuda usu√°rios a encontrarem farm√°cias pr√≥ximas com base no endere√ßo do usu√°rio, baseado nas informa√ß√µes do bairro, cidade, estado informado, apenas para esta localidade. Sua principal fun√ß√£o √© exibir uma tabela informativa e clara contendo os seguintes dados para cada farm√°cia pr√≥xima ao bairro do usu√°rio:
            Nome da Farm√°cia
            Endere√ßo Completo da farm√°cia
            Dist√¢ncia aproximada at√© o bairro do usu√°rio (em metros)
            Telefone para contato
            Oferece servi√ßo de delivery (Sim, N√£o ou n√£o informado)
            """,
        description="Agente identificador de farmacias proximas ao bairro",
        tools=[google_search]
    )
    # Executa o agente
    mapa_farmacia = call_agent(farmacia, f"Farm√°cias em {bairro}, {cidade}, {estado}")
    return mapa_farmacia

##########################################
# --- Agente 4: Agendar Medicamento --- #
##########################################
def agente_agenda(remedio_comprado, qtd_remedios, dia_inicio, hora_inicio, data_de_hoje, entrada_analisador):
    agendador = Agent(
        name="agente_agenda",
        model=MODEL_ID,
        instruction=f"""
            Voc√™ √© um agente de sa√∫de que organiza a rotina de medicamentos de um usu√°rio no Google Agenda.
            Receba como entrada os seguintes dados:
            - Nome do rem√©dio: {remedio_comprado}
            - Quantidade total comprada: {qtd_remedios}
            - Dia de in√≠cio do tratamento: {dia_inicio}
            - Hora do primeiro alarme: {hora_inicio}
            - Data atual: {data_de_hoje}
            - Detalhes da prescri√ß√£o:

            {entrada_analisador}

            Sua tarefa √©:
            1. **Interpretar a frequ√™ncia de uso** do rem√©dio com base nas informa√ß√µes acima.
            2. **Calcular quando o estoque de rem√©dios acabar√°** com base na frequ√™ncia e quantidade dispon√≠vel.
            3. **Planejar quando comprar mais medicamento** - deve ser 1 a 2 dias antes do t√©rmino previsto do estoque.

            IMPORTANTE: Sua resposta DEVE incluir:
            1. A frequ√™ncia de uso em horas (ex: a cada 8 horas)
            2. N√∫mero de comprimidos por dose
            3. Dura√ß√£o total do tratamento em dias
            4. Use exatamente este formato: "FREQU√äNCIA: X horas"
            5. Use exatamente este formato: "COMPRIMIDOS_POR_DOSE: X comprimido(s)"
            6. Use exatamente este formato: "DURA√á√ÉO_DIAS: X dias"
            7. Use exatamente este formato: "DATA DE T√âRMINO DO ESTOQUE: DD/MM/AAAA"
            8. Use exatamente este formato: "DATA DE RECOMPRA: DD/MM/AAAA"

            Forne√ßa tamb√©m um texto para o usu√°rio explicando o plano de administra√ß√£o do medicamento.
            """,
        description="Agente que agenda os dias e hor√°rios dos rem√©dios e necessidade de comprar mais",
        tools=[google_search]
    )
    # Executa o agente
    programacao = call_agent(agendador, "Criar plano de agenda para medicamento")
    return programacao

def executar_agendamento_calendar(remedio_comprado, qtd_remedios, dia_inicio, hora_inicio, resposta_agente):
    """
    Executa o agendamento real no Google Calendar com base na resposta do agente.

    Args:
        remedio_comprado: Nome do medicamento comprado
        qtd_remedios: Quantidade total comprada
        dia_inicio: Data de in√≠cio do tratamento (DD/MM/AAAA)
        hora_inicio: Hora do primeiro alarme (HH:MM)
        resposta_agente: Resposta do agente de agendamento

    Returns:
        Relat√≥rio dos eventos criados
    """
    try:
        # Extrair informa√ß√µes da resposta do agente
        frequencia_match = re.search(r"FREQU√äNCIA:\s*(\d+)\s*horas", resposta_agente)
        comprimidos_match = re.search(r"COMPRIMIDOS_POR_DOSE:\s*(\d+)", resposta_agente)
        duracao_match = re.search(r"DURA√á√ÉO_DIAS:\s*(\d+)", resposta_agente)

        if not (frequencia_match and comprimidos_match and duracao_match):
            return "‚ùå N√£o foi poss√≠vel extrair todas as informa√ß√µes necess√°rias da resposta do agente."

        frequencia = int(frequencia_match.group(1))
        comprimidos_por_dose = int(comprimidos_match.group(1))
        duracao_dias = int(duracao_match.group(1))

        # Configurar acesso ao Google Calendar
        try:
            service = setup_google_calendar()
        except Exception as e:
            return f"‚ùå Erro na configura√ß√£o do Google Calendar: {str(e)}\n\nVerifique se o arquivo 'credentials.json' est√° dispon√≠vel e tente novamente."

        # Agenda os eventos de medica√ß√£o no Google Calendar
        resultados = agendar_medicacao_calendar(
            service,
            remedio_comprado,
            frequencia,
            dia_inicio,
            hora_inicio,
            duracao_dias
        )

        # Prepara o relat√≥rio
        relatorio = "‚úÖ AGENDAMENTO REALIZADO COM SUCESSO NO GOOGLE CALENDAR\n\n"
        relatorio += f"Medicamento: {remedio_comprado}\n"
        relatorio += f"Frequ√™ncia: a cada {frequencia} horas\n"
        relatorio += f"Comprimidos por dose: {comprimidos_por_dose}\n"
        relatorio += f"Dura√ß√£o do tratamento: {duracao_dias} dias\n\n"
        relatorio += "Eventos criados:\n"

        for resultado in resultados:
            relatorio += f"- {resultado}\n"

        # Extrair e adicionar informa√ß√µes sobre recompra
        recompra_match = re.search(r"DATA DE RECOMPRA:\s*(\d{1,2}/\d{1,2}/\d{4})", resposta_agente)
        if recompra_match:
            data_recompra = recompra_match.group(1)
            relatorio += f"\n‚ö†Ô∏è LEMBRETE: Comprar mais {remedio_comprado} em {data_recompra}"

        return relatorio

    except Exception as e:
        return f"‚ùå Erro ao executar agendamento: {str(e)}"

# In√≠cio do programa principal
data_de_hoje = date.today().strftime("%d/%m/%Y")

print("Iniciando o Sistema do Agente de Medicamentos ")

#--- Passo 1: Perguntas b√°sicas ao usu√°rio ---

# A resposta do usu√°rio ser√° armazenada na vari√°vel 'nome_usuario'.
nome_usuario = input("Qual seu nome? ")
print(f"Bem vindo {nome_usuario}, lhe auxiliaremos na busca de informa√ß√µes sobre seus medicamentos!")

# Voc√™ precisar√° convert√™-la para um tipo num√©rico (como int ou float) depois.
idade_usuario = int(input("Qual sua idade? "))

# A resposta ser√° armazenada na vari√°vel 'bairro_usuario'.
bairro_usuario = input("Qual seu bairro? ")

# A resposta ser√° armazenada na vari√°vel 'cidade_usuario'.
cidade_usuario = input("Qual sua cidade? ")

# A resposta ser√° armazenada na vari√°vel 'cidade_usuario'.
estado_usuario = input("Qual seu Estado? ")

# Mostrar as informa√ß√µes coletadas ---
print("\n--- Informa√ß√µes coletadas ---") # Adiciona uma linha em branco e um t√≠tulo
print(f"Nome: {nome_usuario}")
print(f"Idade: {idade_usuario}")
print(f"Bairro: {bairro_usuario}")
print(f"Cidade: {cidade_usuario}")
print(f"Cidade: {estado_usuario}")

receituario = input("‚ùì Por favor, digite o receitu√°rio m√©dico sobre o qual voc√™ quer uma an√°lise: ")

# Inserir l√≥gica do sistema de agentes ################################################
if not receituario:
    print("Voc√™ esqueceu de digitar o receitu√°rio!")
else:
    print(f"Maravilha! Vamos lhe ajudar com seu receitu√°rio m√©dico")

    avaliacao, medicamento, substancia_ativa = agente_avaliador(receituario, idade_usuario, data_de_hoje)
    print("\n--- üìù Resultado do Agente 1 (Buscador) ---\n")
    display(to_markdown(avaliacao))
    print("--------------------------------------------------------------")

    if medicamento is None and substancia_ativa is None:
        print("N√£o foi encontrada nenhuma subst√¢ncia ativa ou medicamento identific√°vel.")
        print("N√£o foi poss√≠vel dar prosseguimento √† an√°lise.")
    else:
        if medicamento is not None:
            entrada = medicamento
            print(f"Medicamento identificado: {medicamento}")
        else:
            entrada = substancia_ativa
            print(f"Subst√¢ncia ativa identificada: {substancia_ativa}")

        generico = agente_generico(entrada, cidade_usuario, estado_usuario)
        print("\n--- üìù Resultado do Agente 2 (Generico) ---\n")
        display(to_markdown(generico))
        print("--------------------------------------------------------------")

        local_farmacia = agente_farmacia(bairro_usuario, cidade_usuario, estado_usuario)
        print("\n--- üìù Resultado do Agente 3 (Farm√°cias locais) ---\n")
        display(to_markdown(local_farmacia))
        print("--------------------------------------------------------------")

        agendar = input("Deseja agendar medicamento em sua agenda? (S/N) ")
        if agendar.upper() == "S":
              remedio_comprado = input("Qual o nome do medicamento comprado? ")
              qtd_remedios = int(input("Qual a quantidade total comprada? "))
              dia_inicio = input("Qual o dia de in√≠cio do tratamento? ")
              hora_inicio = input("Qual a hora do primeiro alarme? ")
              agendamento_remedio = agente_agenda(remedio_comprado, qtd_remedios, dia_inicio, hora_inicio, data_de_hoje, avaliacao)
              print("\n--- üìù Resultado do Agente 4 (Agenda) ---\n")
              display(to_markdown(agendamento_remedio))
        else:
              print("Ok, obrigado por utilizar nosso servi√ßo!"))
              print("--------------------------------------------------------------")
print("Observa√ß√£o: Qualquer d√∫vida, entre em contato com seu m√©dico ou profissional da sa√∫de.")